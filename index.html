<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>D3 Repo-Pipeline Visualizer</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        :root {
            --bg-primary: #f5f5f5;
            --bg-secondary: #ffffff;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #eee;
            --header-border: #4CAF50;
            --repo-fill: #4CAF50;
            --repo-stroke: #388E3C;
            --pipeline-fill: #2196F3;
            --pipeline-stroke: #1976D2;
            --link-color: #999;
            --highlight-color: #FF9800;
            --shadow-color: rgba(0, 0, 0, 0.1);
        }

        [data-theme="dark"] {
            --bg-primary: #1a1a1a;
            --bg-secondary: #2d2d2d;
            --text-primary: #e0e0e0;
            --text-secondary: #b0b0b0;
            --text-tertiary: #808080;
            --border-color: #404040;
            --header-border: #4CAF50;
            --repo-fill: #388E3C;
            --repo-stroke: #2E7D32;
            --pipeline-fill: #1976D2;
            --pipeline-stroke: #1565C0;
            --link-color: #666;
            --highlight-color: #FF9800;
            --shadow-color: rgba(0, 0, 0, 0.5);
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--bg-primary);
            transition: background-color 0.3s ease;
        }

        .control-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--header-border);
        }

        .control-panel-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0;
        }

        .theme-switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .theme-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .theme-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: 0.4s;
            border-radius: 24px;
        }

        .theme-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
        }

        .theme-switch input:checked + .theme-slider {
            background-color: #4CAF50;
        }

        .theme-switch input:checked + .theme-slider:before {
            transform: translateX(26px);
        }

        .theme-icon {
            font-size: 14px;
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            pointer-events: none;
        }

        .theme-icon.sun {
            left: 5px;
        }

        .theme-icon.moon {
            right: 5px;
        }

        #container {
            display: flex;
            gap: 20px;
            height: 100vh;
            padding: 20px;
            box-sizing: border-box;
        }

        #visualization {
            flex: 1;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            overflow: auto;
            transition: background-color 0.3s ease;
            position: relative;
        }

        #control-panel {
            width: 350px;
            background-color: var(--bg-secondary);
            border-radius: 8px;
            box-shadow: 0 2px 8px var(--shadow-color);
            padding: 20px;
            overflow-y: auto;
            transition: background-color 0.3s ease;
            display: flex;
            flex-direction: column;
        }

        .control-section {
            margin-bottom: 20px;
        }

        .control-section h3 {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        #search-box {
            width: 100%;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
            margin-bottom: 10px;
            outline: none;
            transition: border-color 0.3s;
            background-color: var(--bg-primary);
            color: var(--text-primary);
            box-sizing: border-box;
        }

        #search-box:focus {
            border-color: #4CAF50;
        }

        .zoom-controls {
            display: flex;
            gap: 5px;
        }

        .zoom-btn {
            flex: 1;
            padding: 8px 12px;
            background-color: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            transition: background-color 0.3s;
        }

        .zoom-btn:hover {
            background-color: #388E3C;
        }

        .zoom-btn:active {
            transform: scale(0.95);
        }

        #focus-mode-indicator {
            padding: 8px 12px;
            background-color: #FF9800;
            color: white;
            border-radius: 4px;
            font-weight: bold;
            display: none;
            cursor: pointer;
            text-align: center;
            margin-top: 10px;
        }

        #focus-mode-indicator:hover {
            background-color: #F57C00;
        }

        .info-details {
            flex: 1;
            overflow-y: auto;
            margin-bottom: 20px;
        }

        .info-details h2 {
            margin-top: 0;
            color: var(--text-primary);
            font-size: 16px;
            border-bottom: 2px solid var(--header-border);
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        .info-details .info-content {
            color: var(--text-secondary);
        }

        .info-details .info-item {
            margin-bottom: 15px;
        }

        .info-details .info-label {
            font-weight: bold;
            color: var(--text-primary);
            margin-bottom: 5px;
            font-size: 12px;
        }

        .info-details .info-value {
            color: var(--text-secondary);
            padding-left: 10px;
            font-size: 12px;
        }

        .info-details .info-value a {
            color: #2196F3;
            text-decoration: none;
        }

        .info-details .info-value a:hover {
            text-decoration: underline;
        }

        .info-details .connections-list {
            list-style: none;
            padding-left: 10px;
        }

        .info-details .connections-list li {
            padding: 5px 0;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 12px;
        }

        .repo-node {
            fill: var(--repo-fill);
            stroke: var(--repo-stroke);
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .pipeline-node {
            fill: var(--pipeline-fill);
            stroke: var(--pipeline-stroke);
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .repo-node:hover, .pipeline-node:hover {
            opacity: 0.8;
        }

        .node-label {
            font-size: 10px;
            fill: white;
            pointer-events: none;
            text-anchor: middle;
            dominant-baseline: middle;
        }

        .link {
            stroke: var(--link-color);
            stroke-width: 1.5;
            stroke-opacity: 0.3;
            fill: none;
        }

        .link.highlighted {
            stroke: var(--highlight-color);
            stroke-width: 3;
            stroke-opacity: 0.8;
        }

        .node-highlighted {
            filter: drop-shadow(0 0 8px rgba(255, 152, 0, 0.8));
            stroke-width: 3;
        }

        .node-dimmed {
            opacity: 0.2;
        }

        .column-header {
            font-size: 18px;
            font-weight: bold;
            fill: var(--text-primary);
        }

        .empty-state {
            color: var(--text-tertiary);
            font-style: italic;
            text-align: center;
            padding: 20px;
            font-size: 12px;
        }

        .stats-section {
            border-top: 2px solid var(--border-color);
            padding-top: 15px;
            margin-top: auto;
        }

        .stats-section h3 {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-primary);
            margin: 0 0 10px 0;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stats-section div {
            margin: 5px 0;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .stats-section strong {
            color: var(--text-primary);
        }
    </style>
</head>
<body>
    <div id="container">
        <div id="control-panel">
            <!-- En-t√™te avec titre et switch th√®me -->
            <div class="control-panel-header">
                <h1 class="control-panel-title">ArchExplorer</h1>
                <label class="theme-switch">
                    <input type="checkbox" id="theme-toggle">
                    <span class="theme-slider">
                        <span class="theme-icon sun">‚òÄÔ∏è</span>
                        <span class="theme-icon moon">üåô</span>
                    </span>
                </label>
            </div>

            <!-- Section Contr√¥les -->
            <div class="control-section">
                <h3>Contr√¥les</h3>
                <input type="text" id="search-box" placeholder="Rechercher un repo ou pipeline...">
                <div class="zoom-controls">
                    <button class="zoom-btn" id="zoom-in">+</button>
                    <button class="zoom-btn" id="zoom-out">‚àí</button>
                    <button class="zoom-btn" id="zoom-reset">Reset</button>
                </div>
                <div id="focus-mode-indicator">Mode Focus - Cliquez pour quitter</div>
            </div>

            <!-- Section D√©tails -->
            <div class="info-details">
                <div class="empty-state">
                    Cliquez sur un repository ou un pipeline pour voir ses informations
                </div>
            </div>

            <!-- Section Statistiques -->
            <div class="stats-section">
                <h3>Statistiques</h3>
                <div id="total-repos">Repos: 0</div>
                <div id="total-pipelines">Pipelines: 0</div>
                <div id="total-connections">Connexions: 0</div>
            </div>
        </div>

        <div id="visualization"></div>
    </div>

    <script>
        // Fonction de g√©n√©ration de donn√©es
        function generateData() {
            const repoTypes = ['frontend', 'backend', 'api', 'service', 'lib', 'utils', 'sdk', 'mobile', 'web', 'desktop'];
            const repoNames = ['auth', 'payment', 'analytics', 'core', 'common', 'shared', 'ui', 'admin', 'client', 'server'];
            const pipelineTypes = ['build', 'test', 'deploy', 'integration', 'e2e', 'unit', 'lint', 'security', 'performance'];
            const environments = ['dev', 'staging', 'prod', 'qa', 'uat'];
            const statuses = ['success', 'running', 'failed', 'pending'];

            const repos = [];
            for (let i = 1; i <= 150; i++) {
                const type = repoTypes[Math.floor(Math.random() * repoTypes.length)];
                const name = repoNames[Math.floor(Math.random() * repoNames.length)];
                repos.push({
                    id: `repo${i}`,
                    name: `${type}-${name}-${i}`,
                    description: `Repository ${type} pour ${name} (v${Math.floor(Math.random() * 10) + 1}.${Math.floor(Math.random() * 10)})`,
                    url: `https://github.com/org/${type}-${name}-${i}`
                });
            }

            const pipelines = [];
            for (let i = 1; i <= 100; i++) {
                const type = pipelineTypes[Math.floor(Math.random() * pipelineTypes.length)];
                const env = environments[Math.floor(Math.random() * environments.length)];
                const status = statuses[Math.floor(Math.random() * statuses.length)];
                pipelines.push({
                    id: `pipeline${i}`,
                    name: `${type}-${env}-${i}`,
                    description: `Pipeline ${type} pour l'environnement ${env}`,
                    status: status
                });
            }

            // G√©n√©rer des liens avec une distribution vari√©e
            const links = [];
            const linkCounts = new Map();

            // Initialiser les compteurs
            repos.forEach(r => linkCounts.set(r.id, 0));
            pipelines.forEach(p => linkCounts.set(p.id, 0));

            // Distribution: certains sans liens, d'autres avec beaucoup
            repos.forEach(repo => {
                const rand = Math.random();
                let numConnections = 0;

                if (rand < 0.15) {
                    // 15% sans connexion
                    numConnections = 0;
                } else if (rand < 0.40) {
                    // 25% avec 1-3 connexions
                    numConnections = Math.floor(Math.random() * 3) + 1;
                } else if (rand < 0.70) {
                    // 30% avec 4-8 connexions
                    numConnections = Math.floor(Math.random() * 5) + 4;
                } else if (rand < 0.90) {
                    // 20% avec 9-15 connexions
                    numConnections = Math.floor(Math.random() * 7) + 9;
                } else {
                    // 10% avec 16-25 connexions
                    numConnections = Math.floor(Math.random() * 10) + 16;
                }

                // Cr√©er les connexions
                const availablePipelines = [...pipelines];
                for (let i = 0; i < numConnections && availablePipelines.length > 0; i++) {
                    const pipelineIndex = Math.floor(Math.random() * availablePipelines.length);
                    const pipeline = availablePipelines[pipelineIndex];

                    // V√©rifier que le pipeline n'a pas d√©j√† trop de connexions
                    if (linkCounts.get(pipeline.id) < 25) {
                        links.push({
                            source: repo.id,
                            target: pipeline.id
                        });
                        linkCounts.set(repo.id, linkCounts.get(repo.id) + 1);
                        linkCounts.set(pipeline.id, linkCounts.get(pipeline.id) + 1);
                    }
                    availablePipelines.splice(pipelineIndex, 1);
                }
            });

            return { repos, pipelines, links };
        }

        const data = generateData();

        // Mettre √† jour les statistiques
        document.getElementById('total-repos').textContent = `Repos: ${data.repos.length}`;
        document.getElementById('total-pipelines').textContent = `Pipelines: ${data.pipelines.length}`;
        document.getElementById('total-connections').textContent = `Connexions: ${data.links.length}`;

        // Gestion du th√®me
        const themeToggle = document.getElementById('theme-toggle');

        function toggleTheme() {
            const html = document.documentElement;
            const newTheme = themeToggle.checked ? 'dark' : 'light';

            html.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);

            // Redessiner pour appliquer les couleurs
            updateColors();
        }

        // Charger le th√®me sauvegard√©
        const savedTheme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', savedTheme);
        themeToggle.checked = savedTheme === 'dark';

        // √âv√©nement pour le toggle
        themeToggle.addEventListener('change', toggleTheme);

        function updateColors() {
            const styles = getComputedStyle(document.documentElement);

            // Mettre √† jour les nodes
            d3.selectAll('.repo-node')
                .style('fill', styles.getPropertyValue('--repo-fill'))
                .style('stroke', styles.getPropertyValue('--repo-stroke'));

            d3.selectAll('.pipeline-node')
                .style('fill', styles.getPropertyValue('--pipeline-fill'))
                .style('stroke', styles.getPropertyValue('--pipeline-stroke'));

            // Mettre √† jour les liens
            d3.selectAll('.link')
                .style('stroke', styles.getPropertyValue('--link-color'));

            // Mettre √† jour les en-t√™tes
            d3.selectAll('.column-header')
                .style('fill', styles.getPropertyValue('--text-primary'));
        }

        // Configuration
        const margin = { top: 80, right: 40, bottom: 40, left: 40 };
        const vizContainer = d3.select('#visualization');
        const nodeWidth = 180;
        const nodeHeight = 40;

        // Calculer la hauteur n√©cessaire pour afficher tous les repos
        const totalHeight = Math.max(data.repos.length * (nodeHeight + 10), data.pipelines.length * (nodeHeight + 10)) + margin.top + margin.bottom;
        const containerWidth = vizContainer.node().getBoundingClientRect().width;
        const width = containerWidth - margin.left - margin.right;
        const columnSpacing = width * 0.6;

        // √âtat de l'application
        let focusMode = {
            active: false,
            nodeId: null,
            nodeType: null
        };

        // Cr√©er le SVG avec scrolling
        const svg = vizContainer.append('svg')
            .attr('width', containerWidth)
            .attr('height', totalHeight);

        const g = svg.append('g')
            .attr('transform', `translate(${margin.left},${margin.top})`);

        // Configurer le zoom
        const zoom = d3.zoom()
            .scaleExtent([0.1, 4])
            .on('zoom', (event) => {
                g.attr('transform', event.transform);
            });

        svg.call(zoom);

        // En-t√™tes de colonnes
        g.append('text')
            .attr('class', 'column-header')
            .attr('x', nodeWidth / 2)
            .attr('y', -40)
            .attr('text-anchor', 'middle')
            .text('Repositories');

        g.append('text')
            .attr('class', 'column-header')
            .attr('x', columnSpacing + nodeWidth / 2)
            .attr('y', -40)
            .attr('text-anchor', 'middle')
            .text('Pipelines Jenkins');

        // Calculer les positions
        const repoSpacing = nodeHeight + 10;
        const pipelineSpacing = nodeHeight + 10;

        data.repos.forEach((repo, i) => {
            repo.x = 0;
            repo.y = i * repoSpacing;
        });

        data.pipelines.forEach((pipeline, i) => {
            pipeline.x = columnSpacing;
            pipeline.y = i * pipelineSpacing;
        });

        // Cr√©er les liens
        const links = g.append('g')
            .attr('class', 'links')
            .selectAll('path')
            .data(data.links)
            .enter()
            .append('path')
            .attr('class', 'link')
            .attr('d', d => {
                const sourceNode = data.repos.find(r => r.id === d.source);
                const targetNode = data.pipelines.find(p => p.id === d.target);
                const sourceX = sourceNode.x + nodeWidth;
                const sourceY = sourceNode.y + nodeHeight / 2;
                const targetX = targetNode.x;
                const targetY = targetNode.y + nodeHeight / 2;
                const midX = (sourceX + targetX) / 2;
                return `M ${sourceX},${sourceY} C ${midX},${sourceY} ${midX},${targetY} ${targetX},${targetY}`;
            });

        // Cr√©er les nodes des repos
        const repoNodes = g.append('g')
            .attr('class', 'repo-nodes')
            .selectAll('g')
            .data(data.repos)
            .enter()
            .append('g')
            .attr('transform', d => `translate(${d.x},${d.y})`);

        repoNodes.append('rect')
            .attr('class', 'repo-node')
            .attr('width', nodeWidth)
            .attr('height', nodeHeight)
            .attr('rx', 5)
            .on('mouseenter', handleNodeHover)
            .on('mouseleave', handleNodeLeave)
            .on('click', handleNodeClick)
            .on('dblclick', handleNodeDoubleClick);

        repoNodes.append('text')
            .attr('class', 'node-label')
            .attr('x', nodeWidth / 2)
            .attr('y', nodeHeight / 2)
            .text(d => d.name.length > 22 ? d.name.substring(0, 20) + '...' : d.name);

        // Cr√©er les nodes des pipelines
        const pipelineNodes = g.append('g')
            .attr('class', 'pipeline-nodes')
            .selectAll('g')
            .data(data.pipelines)
            .enter()
            .append('g')
            .attr('transform', d => `translate(${d.x},${d.y})`);

        pipelineNodes.append('rect')
            .attr('class', 'pipeline-node')
            .attr('width', nodeWidth)
            .attr('height', nodeHeight)
            .attr('rx', 5)
            .on('mouseenter', handleNodeHover)
            .on('mouseleave', handleNodeLeave)
            .on('click', handleNodeClick)
            .on('dblclick', handleNodeDoubleClick);

        pipelineNodes.append('text')
            .attr('class', 'node-label')
            .attr('x', nodeWidth / 2)
            .attr('y', nodeHeight / 2)
            .text(d => d.name.length > 22 ? d.name.substring(0, 20) + '...' : d.name);

        // Fonctions d'interaction
        function handleNodeHover(event, d) {
            if (focusMode.active) return; // Pas de hover en mode focus

            const nodeType = d.url ? 'repo' : 'pipeline';
            const connectedIds = getConnectedNodes(d.id, nodeType);

            // Mettre en √©vidence les liens connect√©s
            links.classed('highlighted', link =>
                (link.source === d.id || link.target === d.id)
            );

            // Mettre en √©vidence les nodes connect√©s
            repoNodes.selectAll('rect')
                .classed('node-highlighted', repo =>
                    repo.id === d.id || connectedIds.repos.includes(repo.id)
                )
                .classed('node-dimmed', repo =>
                    repo.id !== d.id && !connectedIds.repos.includes(repo.id)
                );

            pipelineNodes.selectAll('rect')
                .classed('node-highlighted', pipeline =>
                    pipeline.id === d.id || connectedIds.pipelines.includes(pipeline.id)
                )
                .classed('node-dimmed', pipeline =>
                    pipeline.id !== d.id && !connectedIds.pipelines.includes(pipeline.id)
                );
        }

        function handleNodeLeave() {
            links.classed('highlighted', false);
            repoNodes.selectAll('rect')
                .classed('node-highlighted', false)
                .classed('node-dimmed', false);
            pipelineNodes.selectAll('rect')
                .classed('node-highlighted', false)
                .classed('node-dimmed', false);
        }

        function handleNodeClick(event, d) {
            event.stopPropagation();
            const nodeType = d.url ? 'repo' : 'pipeline';
            const connectedIds = getConnectedNodes(d.id, nodeType);
            displayNodeInfo(d, nodeType, connectedIds);
        }

        function getConnectedNodes(nodeId, nodeType) {
            const connectedRepos = [];
            const connectedPipelines = [];

            if (nodeType === 'repo') {
                data.links.forEach(link => {
                    if (link.source === nodeId) {
                        connectedPipelines.push(link.target);
                    }
                });
            } else {
                data.links.forEach(link => {
                    if (link.target === nodeId) {
                        connectedRepos.push(link.source);
                    }
                });
            }

            return { repos: connectedRepos, pipelines: connectedPipelines };
        }

        function displayNodeInfo(node, nodeType, connectedIds) {
            const infoPanel = d3.select('.info-details');
            infoPanel.html('');

            const title = infoPanel.append('h2')
                .text(nodeType === 'repo' ? 'Repository' : 'Pipeline Jenkins');

            const content = infoPanel.append('div')
                .attr('class', 'info-content');

            // Nom
            content.append('div')
                .attr('class', 'info-item')
                .html(`<div class="info-label">Nom:</div><div class="info-value">${node.name}</div>`);

            // Description
            content.append('div')
                .attr('class', 'info-item')
                .html(`<div class="info-label">Description:</div><div class="info-value">${node.description}</div>`);

            // Informations sp√©cifiques
            if (nodeType === 'repo') {
                content.append('div')
                    .attr('class', 'info-item')
                    .html(`<div class="info-label">URL:</div><div class="info-value"><a href="${node.url}" target="_blank">${node.url}</a></div>`);

                // Pipelines connect√©s
                const pipelinesSection = content.append('div')
                    .attr('class', 'info-item');
                pipelinesSection.append('div')
                    .attr('class', 'info-label')
                    .text(`Pipelines connect√©s (${connectedIds.pipelines.length}):`);

                if (connectedIds.pipelines.length > 0) {
                    const pipelinesList = pipelinesSection.append('ul')
                        .attr('class', 'connections-list');

                    connectedIds.pipelines.forEach(pipelineId => {
                        const pipeline = data.pipelines.find(p => p.id === pipelineId);
                        pipelinesList.append('li')
                            .text(pipeline.name);
                    });
                } else {
                    pipelinesSection.append('div')
                        .attr('class', 'info-value')
                        .style('font-style', 'italic')
                        .text('Aucun pipeline connect√©');
                }
            } else {
                // Statut
                const statusColors = {
                    'success': 'üü¢',
                    'running': 'üü°',
                    'failed': 'üî¥',
                    'pending': '‚ö™'
                };
                content.append('div')
                    .attr('class', 'info-item')
                    .html(`<div class="info-label">Statut:</div><div class="info-value">${statusColors[node.status] || ''} ${node.status}</div>`);

                // Repos connect√©s
                const reposSection = content.append('div')
                    .attr('class', 'info-item');
                reposSection.append('div')
                    .attr('class', 'info-label')
                    .text(`Repositories connect√©s (${connectedIds.repos.length}):`);

                if (connectedIds.repos.length > 0) {
                    const reposList = reposSection.append('ul')
                        .attr('class', 'connections-list');

                connectedIds.repos.forEach(repoId => {
                    const repo = data.repos.find(r => r.id === repoId);
                    reposList.append('li')
                        .text(repo.name);
                });
            }
            }
        }

        // Fonction pour le mode Focus (double-clic)
        function handleNodeDoubleClick(event, d) {
            event.stopPropagation();
            const nodeType = d.url ? 'repo' : 'pipeline';

            if (focusMode.active && focusMode.nodeId === d.id) {
                // D√©sactiver le mode focus si on double-clique sur le m√™me node
                exitFocusMode();
            } else {
                // Activer le mode focus
                enterFocusMode(d.id, nodeType);
            }
        }

        function enterFocusMode(nodeId, nodeType) {
            focusMode.active = true;
            focusMode.nodeId = nodeId;
            focusMode.nodeType = nodeType;

            const connectedIds = getConnectedNodes(nodeId, nodeType);

            // Afficher l'indicateur de mode focus
            d3.select('#focus-mode-indicator').style('display', 'block');

            // Masquer les liens non connect√©s
            links.style('display', link =>
                (link.source === nodeId || link.target === nodeId) ? 'block' : 'none'
            );

            // Mettre en √©vidence les nodes connect√©s et masquer les autres
            repoNodes.selectAll('rect')
                .classed('node-highlighted', repo => repo.id === nodeId || connectedIds.repos.includes(repo.id))
                .classed('node-dimmed', repo => repo.id !== nodeId && !connectedIds.repos.includes(repo.id));

            repoNodes.selectAll('text')
                .style('opacity', d => (d.id === nodeId || connectedIds.repos.includes(d.id)) ? 1 : 0.2);

            pipelineNodes.selectAll('rect')
                .classed('node-highlighted', pipeline => pipeline.id === nodeId || connectedIds.pipelines.includes(pipeline.id))
                .classed('node-dimmed', pipeline => pipeline.id !== nodeId && !connectedIds.pipelines.includes(pipeline.id));

            pipelineNodes.selectAll('text')
                .style('opacity', d => (d.id === nodeId || connectedIds.pipelines.includes(d.id)) ? 1 : 0.2);
        }

        function exitFocusMode() {
            focusMode.active = false;
            focusMode.nodeId = null;
            focusMode.nodeType = null;

            // Cacher l'indicateur
            d3.select('#focus-mode-indicator').style('display', 'none');

            // R√©afficher tous les liens
            links.style('display', 'block');

            // R√©initialiser tous les nodes
            repoNodes.selectAll('rect')
                .classed('node-highlighted', false)
                .classed('node-dimmed', false);

            repoNodes.selectAll('text').style('opacity', 1);

            pipelineNodes.selectAll('rect')
                .classed('node-highlighted', false)
                .classed('node-dimmed', false);

            pipelineNodes.selectAll('text').style('opacity', 1);
        }

        // Fonction de recherche
        function handleSearch(searchTerm) {
            const term = searchTerm.toLowerCase().trim();

            if (term === '') {
                // R√©initialiser si la recherche est vide
                repoNodes.selectAll('rect').classed('node-dimmed', false);
                pipelineNodes.selectAll('rect').classed('node-dimmed', false);
                repoNodes.selectAll('text').style('opacity', 1);
                pipelineNodes.selectAll('text').style('opacity', 1);
                links.style('opacity', 0.3);
                return;
            }

            // Filtrer les repos
            const matchingRepos = data.repos.filter(r =>
                r.name.toLowerCase().includes(term) ||
                r.description.toLowerCase().includes(term)
            ).map(r => r.id);

            // Filtrer les pipelines
            const matchingPipelines = data.pipelines.filter(p =>
                p.name.toLowerCase().includes(term) ||
                p.description.toLowerCase().includes(term)
            ).map(p => p.id);

            // Appliquer le filtre visuel
            repoNodes.selectAll('rect')
                .classed('node-dimmed', d => !matchingRepos.includes(d.id));

            repoNodes.selectAll('text')
                .style('opacity', d => matchingRepos.includes(d.id) ? 1 : 0.2);

            pipelineNodes.selectAll('rect')
                .classed('node-dimmed', d => !matchingPipelines.includes(d.id));

            pipelineNodes.selectAll('text')
                .style('opacity', d => matchingPipelines.includes(d.id) ? 1 : 0.2);

            // Mettre en √©vidence les liens connect√©s aux r√©sultats
            links.style('opacity', link => {
                const sourceMatch = matchingRepos.includes(link.source);
                const targetMatch = matchingPipelines.includes(link.target);
                return (sourceMatch || targetMatch) ? 0.6 : 0.1;
            });
        }

        // Contr√¥les de zoom
        d3.select('#zoom-in').on('click', () => {
            svg.transition().call(zoom.scaleBy, 1.3);
        });

        d3.select('#zoom-out').on('click', () => {
            svg.transition().call(zoom.scaleBy, 0.7);
        });

        d3.select('#zoom-reset').on('click', () => {
            svg.transition().call(zoom.transform, d3.zoomIdentity);
        });

        // Barre de recherche
        d3.select('#search-box').on('input', function() {
            handleSearch(this.value);
        });

        // Indicateur de mode focus
        d3.select('#focus-mode-indicator').on('click', exitFocusMode);

        // Responsive
        window.addEventListener('resize', () => {
            location.reload();
        });

        // Indicateur de mode focus
        d3.select('#focus-mode-indicator').on('click', exitFocusMode);

        // Appliquer les couleurs initiales
        updateColors();
    </script>
</body>
</html>
